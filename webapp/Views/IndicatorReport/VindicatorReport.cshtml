
<script src="~/Scripts/util/jsUtilCambioGuardia.js"></script>
<script src="~/Scripts/plugin/dygraphs/dygraph-combined.min.js"></script>
<link href="~/Content/plugin/datapicker/datepicker3.css" rel="stylesheet" />
<link href="~/Content/plugin/awesome-bootstrap-checkbox/awesome-bootstrap-checkbox.css" rel="stylesheet" />
<script src="~/Scripts/plugin/datapicker/bootstrap-datepicker.js"></script>
<script src="~/Scripts/jquery.session.js"></script>
<script src="~/Scripts/bootstrap-filestyle.min.js"></script>

<script type="text/javascript">
    function anular(e) {

        tecla = (document.all) ? e.keyCode : e.which;
        return (tecla != 13);
    }
</script>

<style>
    .k-tooltip, .k-chart-tooltip {
        font-size: 15px !important;
    }

    .jqstooltip {
        font-size: 20px !important;
        padding: 5px !important;
        overflow: auto !important;
        text-align: center !important;
        border-color: #CCCCCC !important;
        max-width: 400px !important;
        max-height: 400px !important;
    }

    .jqsfield {
        font-size: 20px !important;
    }
</style>

<div id="content">

    <div class="well" style="padding: 0px 30px 10px 30px; background-color: white;" onkeypress="return anular(event)">
        <div class="row wrapper">
            <div style="width: 100%; display:flex; flex-direction:row; flex-wrap:nowrap; justify-content:space-between; text-align:center; align-items:center;">
                <h2 title="Reporte de Indicadores"><i class="fa fa-bar-chart-o fa-fw"></i> [Reporte de Indicadores]</h2>
            </div>
            <form id="FrmFiltros" onsubmit="return false">
                <div class="col-xs-12 ContenedoresReportes">
                    <div class="row">
                        <section class="col-xs-6 col-md-3">
                            <label style="color: #2F4050">Desde: </label>
                            <div class="input-group date dtpickerFI">
                                <input type="text" class="form-control hasDatepicker" id="txtFechaInicio" name="txtFechaInicio" value="" data-dateformat="dd/mm/yy">
                                <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
                            </div>
                        </section>
                        <section class="col-xs-6 col-md-3">
                            <label style="color: #2F4050">Hasta: </label>
                            <div class="input-group date dtpickerFF">
                                <input type="text" class="form-control hasDatepicker" id="txtFechaFinal" name="txtFechaFinal" value="" data-dateformat="dd/mm/yy">
                                <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
                            </div>
                        </section>
                        @*<section class="col-xs-12 col-sm-12 col-md-6 col-lg-4">
                                <label style="color: #2F4050">Búsqueda por: </label>
                                <div class="input-group">
                                    <div class="radio radio-info radio-inline">
                                        <input tabindex="7" type="radio" name="RrbCriterio" id="RrbTodos" checked="checked">
                                        <label for="RrbTodos"> Todos </label>
                                    </div>
                                    <div class="radio radio-info radio-inline">
                                        <input tabindex="7" type="radio" name="RrbCriterio" id="RrbUsuario">
                                        <label for="RrbUsuario"> Mi usuario </label>
                                    </div>
                                </div>
                            </section>*@
                    </div>
                    <div class="row">
                        <section class="col-xs-6 col-md-3">
                            <label style="color: #2F4050">Tipo :</label>
                            <div style="width: 100%;">
                                <input id="cboTipo" style="width:100%;" />
                            </div>
                        </section>
                        <section class="col-xs-6 col-md-3">
                            <label style="color: #2F4050">Incidencia :</label>
                            <div style="width: 100%;">
                                <input id="cboIncidencia" style="width:100%;" />
                            </div>
                        </section>
                        <section class="col-xs-4 col-md-6">
                            <div style="margin-top:15px; display:flex; flex-direction:row; flex-wrap:wrap; justify-content:flex-end">
                                <button style="margin:0px;" tabindex="9" class="btn btn-primary" type="submit" id="btnBuscar" disabled><i class="fa fa-search"></i> Buscar</button>
                            </div>
                        </section>
                    </div>
                    <div class="row">

                    </div>
                    <div class="row">
                        <div style="margin-top:10px;" class="col-xs-12">
                            <button class="btn btn-success pull-right" type="button" id="BtnExportarExcel" disabled title="Exportar listado a Excel"><i class="fa fa-file-excel-o"></i> Excel</button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div id="widget-grid">
        <div class="row">
            <article class="col-xs-12 ContenedoresReportes">
                <div class="jarviswidget jarviswidget-color-blue" id="wid-id-rga1" data-widget-editbutton="false" data-widget-custombutton="false" style="border: 2px solid #2F4050">
                    <header>
                        <span class="widget-icon"> <i class="fa fa-list"></i> </span>
                        <h2>Reporte de Indicadores</h2>
                    </header>
                    <div style="border:none;">
                        <div class="jarviswidget-editbox">
                            <!-- This area used as dropdown edit box -->
                        </div>
                        <div class="widget-body no-padding">

                            <div id="LstReporte" class="hidden"></div>
                            <div class="spiner-example" id="imgCargaLstReporte">
                                @Html.Partial("../MensajesParciales/_MensajeCargando")
                            </div>

                            <div class="hidden" id="msjErrorLstReporte" style="margin:30px;">
                                @Html.Partial("../MensajesParciales/_MensajeError")
                            </div>

                            <div class="hidden" id="msjVacioLstReporte" style="margin:30px;">
                                @Html.Partial("../MensajesParciales/_MensajeVacio")
                            </div>

                            <div class="hidden" id="msjErrorListarLstReporte" style="margin:30px;">
                                @Html.Partial("../MensajesParciales/_MensajeErrorListar")
                            </div>
                            <div class="hidden" id="msjSuperaLimiteLstReporte" style="margin:30px;">
                                @Html.Partial("../MensajesParciales/_MensajeLimiteGraficas")
                            </div>
                        </div>
                    </div>
                </div>
            </article>
        </div>
    </div>
</div>

<div id="ModalComment" class="modal inmodal fade" tabindex="-1" role="dialog" aria-hidden="true">

    <div class="modal-dialog" style="width:90%;">
        <div class="modal-content animated">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title"><b>Incidencia: <label id="lblIncidencia" style="font-weight:bold;"></label></b></h4>
            </div>
            <div class="modal-body clearfix" style="padding-left:10px; padding-right:10px;">
                <form id="FrmComentarioIncidencia" onsubmit="return false">
                    <section class="col-xs-12 col-sm-12 col-lg-12">
                        <label style="color: #2F4050">Detalle incidencia: </label>
                        <div class="pull-right">
                            <label style="color: #2F4050">Fecha Registro : </label><label id="lblFecha" style="color: #2F4050"></label>
                        </div>
                        <div id="a" class="" style="width: 100%; height:50%; display:flex; flex-flow:row nowrap;">
                            <textarea id="txtDetalle" name="txtDetalle" disabled style="width:100%;height:50px; overflow-y:scroll; resize:none; border-radius: 8px;
                                                                border: 1px solid #888; background-color:lightgray; border-color:lightgray; outline: none;
                                                                margin: 8px; padding:6px;" rows="5"></textarea>
                        </div>
                    </section>
                    @*<div class="row">
                            <div style="margin-top:10px; margin-bottom:15px;" class="col-xs-12">
                                <button class="btn btn-success pull-right" type="button" id="BtnExportarPDF" disabled title="Exportar comentarios a Pdf"><i class="fa fa-file-pdf-o"></i> PDF </button>
                            </div>
                        </div>*@

                    <div class="row">
                        <article class="col-xs-12">

                            <div class="jarviswidget jarviswidget-color-blue" id="wid-id-conductor" data-widget-editbutton="false" data-widget-custombutton="false" style="border: 2px solid #2F4050;">
                                <header>
                                    <span class="widget-icon"> <i class="fa fa-list"></i> </span>
                                    <h2>Comentarios de Incidencia </h2>
                                </header>
                                <div id="comentariosDescrip" style="border:none; height:180px; overflow-y:scroll;">
                                    <div class="jarviswidget-editbox">
                                        <!-- This area used as dropdown edit box -->
                                    </div>
                                    <div></div>
                                    <div class="widget-body no-padding" style="margin:8px;" id="ContenedorComentario">
                                        <ul class="notification-body hidden" id="ComentariosIncidencia"></ul>
                                        
                                        <div>
                                            <div class="spiner-example" id="imgCargaComentario">
                                                @Html.Partial("../MensajesParciales/_MensajeCargando")
                                            </div>

                                            <div class="hidden" id="msjErrorComentario" style="margin:30px;">
                                                @Html.Partial("../MensajesParciales/_MensajeError")
                                            </div>

                                            <div class="hidden" id="msjVacioComentario" style="margin:30px;">
                                                @Html.Partial("../MensajesParciales/_MensajeVacioComentario")
                                            </div>

                                            <div class="hidden" id="msjErrorListarComentario" style="margin:30px;">
                                                @Html.Partial("../MensajesParciales/_MensajeErrorListar")
                                            </div>
                                            <div class="hidden" id="msjSuperaLimiteComentario" style="margin:30px;">
                                                @Html.Partial("../MensajesParciales/_MensajeLimiteGraficas")
                                            </div>
                                        
                                        </div>

                                    </div>
                                </div>
                                <div id="ContenedorListaComentario">
                                   
                                    <div class="row" >
                                        <section class="col-xs-12 col-md-12">
                                            <i style="font-size:12px; color:black; font-style:normal;">
                                                NUEVO COMENTARIO <em>(Se permite un máximo de 500 caracteres)</em> : <strong class="CampoRequerido">*</strong>
                                            </i>
                                            <textarea id="txtNuevoComentario" name="txtNuevoComentario" maxlength="500" type="text" style="width:100%;height:50px; overflow-y:scroll; resize:none; border-radius: 8px;
                                                                border: 1px solid #888; background-color:white; border-color:lightgray; outline: none;
                                                                margin: 8px; padding:6px;" rows="5"></textarea>

                                        </section>
                                    </div>
                                    <div class="row">
                                        <section class="col-xs-12 col-md-6">
                                            <i style="font-size:12px; color:black; font-style:normal;">
                                                ADJUNTAR ARCHIVO <em>(Se permite un máximo de 5MB por archivo)</em> :
                                            </i>
                                            <div class="input-group" style="width:100%; padding: 5px;">
                                                <input type="file" style="width:100%;" class="filestyle" name="flArchivoSubir" id="flArchivoSubir"
                                                       accept=".rar, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel, image/jpeg, application/pdf, application/vnd.openxmlformats-officedocument.wordprocessingml.document, application/zip,text/plain"
                                                       data-buttontext="Examinar" data-buttonname="btn btn-primary" />
                                            </div>
                                        </section>
                                        <section class="col-xs-12 col-md-6" style="padding-top:14px;">
                                            <button type="submit" id="btnAgregarComentario" class="btn btn-success" style="margin: 8px;">Enviar Comentario</button>
                                            <button class="btn btn-success pull-right" type="button" id="BtnExportarPDF" disabled title="Exportar comentarios a Pdf"><i class="fa fa-file-pdf-o"></i> PDF </button>
                                        </section>

                                    </div>
                                    <div style="margin-top:10px; display:flex; flex-direction:row; flex-wrap:wrap; justify-content:flex-start">
                                        @Html.Partial("../MensajesParciales/_MensajeLeyendaCampoRequerido")
                                    </div>
                                </div>
                            </div>
                        </article>
                    </div>
                </form>
            </div>
        </div>
    </div>

</div>

<div id="ModalActualizarComment" class="modal inmodal fade" tabindex="-1" role="dialog" aria-hidden="true">

    <div class="modal-dialog" style="width:50%;">
        <div class="modal-content animated">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title">
                    <b>Actualizar Inicidencia</b>
                    <i class="icon-append fa fa-info-circle" style="color:blue; cursor:pointer; width:15px; height:15px;" id="btnInformativo"></i>
                </h4>

            </div>
            <div class="modal-body clearfix" style="padding-left:10px; padding-right:10px;">
                <form id="FrmActualizarComentario" onsubmit="return false">
                    <div class="row">
                        <section class="col-xs-12 col-md-12">
                            <label style="color: #2F4050">Comentario <em style="font-size:12px;">(Se permite un máximo de 500 caracteres)</em> : <strong class="CampoRequerido">*</strong></label>
                            <div class="input-group" style="width:100%; padding: 10px;">
                                <textarea id="txtComentario" name="txtComentario" maxlength="500" style="width:100%; height:50px; overflow-y:scroll; resize:none; border-radius: 8px; border: 1px solid #888; background-color:white; border-color:lightgray; outline: none; margin: 8px; padding-left:5px;"
                                          rows="5"></textarea>
                            </div>
                        </section>
                    </div>
                    <div class="row">
                        <section class="col-xs-12 col-md-12">
                            <label style="color: #2F4050">Adjuntar Archivo <em style="font-size:12px;">(Si existe un archivo adjunto se sobreescribira por este y solo se permite un máximo de 5MB por archivo)</em> : </label>
                            <div class="input-group" style="width:100%; padding: 15px;">
                                <input type="file" style="width:100%;" class="filestyle" name="flArchivoSubirActualizar" id="flArchivoSubirActualizar"
                                       accept=".rar, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel, image/jpeg, application/pdf, application/vnd.openxmlformats-officedocument.wordprocessingml.document, application/zip,text/plain"
                                       data-buttontext="Examinar" data-buttonname="btn btn-primary" />
                            </div>
                        </section>
                    </div>
                    <div class="row">
                        <section class="col-xs-12" style="display:flex; flex-direction:row; flex-wrap:wrap; justify-content:space-between">
                            <div style="margin-top:10px; display:flex; flex-direction:row; flex-wrap:wrap; justify-content:flex-start">
                                @Html.Partial("../MensajesParciales/_MensajeLeyendaCampoRequerido")
                            </div>
                            <div style="margin-top:10px; display:flex; flex-direction:row; flex-wrap:wrap; justify-content:flex-end">
                                <button style="margin:3px;" tabindex="17" class="btn btn-danger" type="button" id="cbtnCancelar"><i class="fa fa-times-circle"></i> Cancelar</button>
                                <button style="margin:3px;" tabindex="16" class="btn btn-primary" type="submit" id="cbtnGrabar"><i class="fa fa-save"></i> Grabar</button>
                            </div>
                        </section>
                    </div>
                </form>
            </div>
        </div>
    </div>

</div>
<div id="ModalLeyenda" class="modal inmodal fade" tabindex="-1" role="dialog" aria-hidden="true">

    <div class="modal-dialog" style="width:30%">
        <div class="modal-content animated">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title">Notas <i class="icon-append fa fa-info-circle" style="color:blue; width:15px; height:15px;"></i></h4>
            </div>
            <div class="modal-body clearfix" style="padding-left:10px; padding-right:10px;">
                <div id="Leyenda"></div>
            </div>
        </div>
    </div>
</div>


<div>
    <script>

    /*-------funcion para el icono informativo-----*/
    function MostrarMapaTitle() {

        var cuerpoInicio = "";
        var cuerpo = "";
        var contador = 0;

        if (contador == 0) {
            cuerpoInicio = "<span style='font-weight:bold; font-size:17px;'>(*)Al adjuntar otro archivo en el comentario,<br> este reemplazara al que ya tenía el comentario.</span> <br>";
        }

        cuerpo = cuerpo + "</ul>";
        $("#Leyenda").html(cuerpoInicio + cuerpo);
        $("#ModalLeyenda").modal("show");
    }

    //---------------------------------------------------------------------------------------------------- VARIABLES
    var idTipoIndicador = 0;
    var tipoIndicador = "";
    var idIndicatorComment = 0;
    var cuerpoNotificacion = ""; //llena el html del notificacion
    var arrayTotal = [];
    var idIndicator = 0;
    var idUsuario = 0;
    var idIndicadorUser = 0;

    /*---------------------------------------------------------------------------------------------------------*/

    function ObtenerComentarios(IdIncidenciaUser) {

        cuerpoNotificacion = "";

        $("#ComentariosIncidencia").html("");
        $("#imgCargaComentario").removeClass("hidden");
        $("#ComentariosIncidencia").addClass("hidden");
        $("#msjErrorComentario").addClass("hidden");
        $("#msjVacioComentario").addClass("hidden");
        $("#msjErrorListarComentario").addClass("hidden");

        $("#ContenedorListaComentario").removeClass("hidden");

        $("#BtnExportarPDF").prop('disabled', true);

        $.ajax({
            type: "GET",
            url: tRutaServidor + "/IndicatorAnswer/ListarRespuestaIndicador",
            contentType: "application/json; charset=utf-8",
            data: {
                IdIndicatorUser: IdIncidenciaUser,
                RegistrationUser: 0
            },
            dataType: "json",
            /*async: false,*/
            success: function (resultado) {

                //resultado = [];
                //resultado[0].ValorConsulta = 2;

                /*exitosamente*/
                if (resultado.length > 0) {
                    /* proceso exitoso con datos*/
                    if (resultado[0].ValorConsulta == "1") {

                        $("#imgCargaComentario").addClass("hidden");
                        $("#ComentariosIncidencia").removeClass("hidden");
                        $("#msjErrorComentario").addClass("hidden");
                        $("#msjVacioComentario").addClass("hidden");
                        $("#msjErrorListarComentario").addClass("hidden");

                        $("#BtnExportarPDF").prop('disabled', false);

                        var USER = "@User.Identity.Name.ToUpper().ToString()";
                      

                        for (i = 0; i < resultado.length; i++) {
                            arrayTotal.push({ IdIndicatorComment: resultado[i].IdIndicatorComment });
                            cuerpoNotificacion +=
                            '<li class="liN li' + resultado[i].IdIndicatorComment + '">';
                            if (resultado[i].RegistrationUser == (split[0])) {
                                cuerpoNotificacion += '<span title="Editar comentario" class="pull-left text-muted small" style="margin-right:15px" onclick="editarComentario(' + resultado[i].IdIndicatorComment + ",'" + resultado[i].Comment + "'" + ')"><i class="fa fa-edit" style="color:#1AB394"></i></span>';
                                cuerpoNotificacion += '<span title="Eliminar comentario" class="pull-left text-muted small" style="margin-right:15px" onclick="eliminarComentario(' + resultado[i].IdIndicatorComment + ')"><i class="fa fa-times" style="color:#FF2700"></i></span>';
                            }

                            cuerpoNotificacion += '<span class="" style="font-style:italic"><i style="font-size:10px; color:black; font-style:normal;">USUARIO: </i><i style="font-weight:bold;">"' + resultado[i].bE_Indicator_User.UserDesc + '</i> <i style="font-size:10px; color:black; font-style:normal;"> &nbsp;&nbsp; FECHA:</i> <i style="color:gray"> &nbsp;&nbsp;"' + resultado[i].RegistrationDateString + '"</i></span>'

                            if (resultado[i].PathFile != "") {
                                cuerpoNotificacion += '<span title="Archivo Adjunto" class="pull-left text-muted small" style="margin-right:15px;"><a href="' + resultado[i].PathFile + '"" target="_blank" style="text-decoration:none; color:black;"><i class="fa fa-file" > ' + resultado[i].FileName + '</i></a></span>';
                            }

                            cuerpoNotificacion += '<textarea disabled id="txtArea-' + resultado[i].IdIndicatorComment + '" style="padding:8px; overflow-y:scroll; width:100%;height:45px; resize:none; border: 1px solid #888; border-radius: 8px; background-color:lightgray; color:black; border: thin; outline: none;" >' + resultado[i].Comment + '</textarea>' +
                            '</li>';
                        }

                        $('#ComentariosIncidencia').append(cuerpoNotificacion);
                        setTimeout(function () {
                            $("#comentariosDescrip").scrollTop(99999);
                        }, 500);

                    } else {

                        $("#imgCargaComentario").addClass("hidden");
                        $("#ComentariosIncidencia").addClass("hidden");
                        $("#msjErrorComentario").addClass("hidden");
                        $("#msjVacioComentario").addClass("hidden");
                        $("#msjErrorListarComentario").removeClass("hidden");

                        $("#ContenedorListaComentario").addClass("hidden");
                    }
                } else {

                    $("#imgCargaComentario").addClass("hidden");
                    $("#ComentariosIncidencia").addClass("hidden");
                    $("#msjErrorComentario").addClass("hidden");
                    $("#msjVacioComentario").removeClass("hidden");
                    $("#msjErrorListarComentario").addClass("hidden");
                }


            },
            error: function (xhr, ajaxOptions, thrownError) {
                /*fallo al llamar a la funcion ajax*/
                $("#imgCargaComentario").addClass("hidden");
                $("#ComentariosIncidencia").addClass("hidden");
                $("#msjErrorComentario").removeClass("hidden");
                $("#msjVacioComentario").addClass("hidden");
                $("#msjErrorListarComentario").addClass("hidden");

                $("#ContenedorListaComentario").addClass("hidden");

                console.log("ERROR AJAX : " + ajaxOptions);
                console.log("ERROR AJAX : " + thrownError);
                console.log(xhr.responseText);
                console.log(xhr);

            }
        });
    }

    function editarComentario(IdIndicatorComment, Comment) {

        //$("#txtArea-" + IdIndicatorComment + "").prop('disabled', false);
        //$("#txtArea-" + IdIndicatorComment + "").css('background-color', "white");
        //$("#txtArea-" + IdIndicatorComment + "").css('border-color', "lightgray");
        //$("#txtArea-" + IdIndicatorComment + "").css('border', "1px solid #888");
        //$("#txtArea-" + IdIndicatorComment + "").css('outline', "none");

        $("#txtComentario").val(Comment);
        idIndicatorComment = IdIndicatorComment;

        $('#ModalActualizarComment').modal('show');
    }

    function eliminarComentario(IdIndicatorComment) {
        swal({
            title: tTituloConfirmacion,
            text: tMensajeConfirmacionEliminarComentario,
            type: "warning",
            showCancelButton: true,
            confirmButtonColor: tColorBoton,
            confirmButtonText: tNombreBotonSi,
            cancelButtonText: tNombreBotonNo,
            closeOnConfirm: true
        }, function () {
            eliminarComentarioConfirmacion(IdIndicatorComment);
        });
    }

    function eliminarComentarioConfirmacion(IdIndicatorComment) {

        $("#imgCargaComentario").removeClass("hidden");

        $.ajax({
            type: "POST",
            url: tRutaServidor + "/IndicatorAnswer/EliminarRespuestaIndicador",
            dataType: "json",
            data: {
                IdIndicatorComment: IdIndicatorComment
            },
            success: function (resultado) {

                if (resultado == "1") {
                    $("#imgCargaComentario").addClass("hidden");
                    toastr.options.timeOut = nTiempoCorto;
                    toastr.options.extendedTimeOut = nTiempoCorto;
                    /*success - info - warning - error*/
                    var $toast = toastr["success"](tMensajeEliminadoExito, tTituloExito); $toastlast = $toast;
                    $("#imgCargaComentario").removeClass("hidden");

                    ObtenerComentarios(idIndicadorUser);

                } else if (resultado == "0") {
                    $("#imgCargaComentario").addClass("hidden");
                    toastr.options.timeOut = nTiempoMedio;
                    toastr.options.extendedTimeOut = nTiempoMedio;
                    /*success - info - warning - error*/
                    var $toast = toastr["error"](tMensajeErrorDesconocido, tTituloError); $toastlast = $toast;
                    console.log("Mensaje del error : " + resultado)
                } else if (resultado == "3") {
                    $("#imgCargaComentario").addClass("hidden");
                    toastr.options.timeOut = nTiempoMedio;
                    toastr.options.extendedTimeOut = nTiempoMedio;
                    /*success - info - warning - error*/
                    var $toast = toastr["error"](tMensajeErrorNoExiste, tTituloError); $toastlast = $toast;
                    console.log("Mensaje del error : " + resultado)
                } else {
                    $("#imgCargaComentario").addClass("hidden");
                    toastr.options.timeOut = nTiempoMedio;
                    toastr.options.extendedTimeOut = nTiempoMedio;
                    /*success - info - warning - error*/
                    var $toast = toastr["error"](tMensajeErrorDesconocido, tTituloError); $toastlast = $toast;
                    console.log("Mensaje del error : " + resultado)
                }

            },
            error: function (xhr, ajaxOptions, thrownError) {
                $("#imgCargaComentario").addClass("hidden");
                /*fallo al llamar a la funcion ajax*/
                toastr.options.timeOut = nTiempoLargo;
                toastr.options.extendedTimeOut = nTiempoLargo;
                /*success - info - warning - error*/
                var $toast = toastr["error"](tMensajeErrorConexion, tTituloErrorConexion); $toastlast = $toast;
                console.log("ERROR AJAX : " + ajaxOptions);
                console.log("ERROR AJAX : " + thrownError);
                console.log(xhr.responseText);
                console.log(xhr);
            }
        });



    }

    /*$(document).ready(function () {*/



    //---------------------------------------------------------------------------------------------------- GRILLAS
    function GrillaListado() {

        $.session.get("DatosIncidencias");

        if ($.session.get("DatosIncidencias") != null) {

            var datosIncidencias = [];
            datosIncidencias = $.session.get("DatosIncidencias");
            var datos = [];
            datos = String(datosIncidencias).split(',');

            idTipoIndicador = datos[1].toString();
            $("#cboTipo").data("kendoDropDownList").value(idTipoIndicador);
            ComboIndicadores(idTipoIndicador);

            idIndicator = datos[0].toString();
            $("#cboIncidencia").data("kendoDropDownList").value(idIndicator);

            $("#txtFechaInicio").val(datos[2].toString());
            $("#txtFechaFinal").val(datos[3].toString());

            //idUsuario = 1;
            //$('#RrbUsuario').prop('checked', true);

            $.session.remove("DatosIncidencias");
        } else {
            //$('#RrbTodos').prop('checked', true);
        }

        //$('input[type=radio][name=RrbCriterio]').change(function (e) {

        //    if (e.target.id == 'RrbTodos') {
        //        idUsuario = 0;
        //    } else if (e.target.id == 'RrbUsuario') {
        //        idUsuario = 1;
        //    }
        //});
        /*validacion de fechas por el onselect*/
        var fechainicio = $('#txtFechaInicio').val();
        var Validacionfechainicio = ReFecha.exec(fechainicio);

        var fechafin = $('#txtFechaFinal').val();
        var Validacionfechafin = ReFecha.exec(fechafin);

        if (!Validacionfechainicio) {
            toastr.options.timeOut = nTiempoLargo;
            toastr.options.extendedTimeOut = nTiempoLargo;
            /*success - info - warning - error*/
            var $toast = toastr["error"](tCaracteresNoValidoFecha, tTituloError); $toastlast = $toast;
        } else if (!Validacionfechafin) {
            toastr.options.timeOut = nTiempoLargo;
            toastr.options.extendedTimeOut = nTiempoLargo;
            /*success - info - warning - error*/
            var $toast = toastr["error"](tCaracteresNoValidoFecha, tTituloError); $toastlast = $toast;
        } else {

            var dataSource = new kendo.data.DataSource({

                transport: {
                    read: function (options) {
                        $.ajax({
                            type: "POST",
                            url: tRutaServidor + "/Indicator/listarIndicadorReporte", /* es importante poner los .. delante*/
                            data: { StartDate: fechainicio, EndDate: fechafin, IdIndicator: idIndicator, IdIndicatorType: idTipoIndicador, IdUser: idUsuario },
                            dataType: "json",
                            success: function (resultado) {

                                //resultado = [];
                                //resultado[0].ValorConsulta = '2';
                                /*exitosamente*/
                                if (resultado.length > 0) {
                                    /* proceso exitoso con datos*/
                                    if (resultado[0].ValorConsulta == "1") {
                                        $("#LstReporte").removeClass("hidden");
                                        $("#imgCargaLstReporte").addClass("hidden");
                                        $("#msjErrorLstReporte").addClass("hidden");
                                        $("#msjVacioLstReporte").addClass("hidden");
                                        $("#msjErrorListarLstReporte").addClass("hidden");
                                        $("#msjSuperaLimiteLstReporte").addClass("hidden");

                                        $("#btnBuscar").prop('disabled', false);
                                        $("#BtnExportarExcel").prop('disabled', false);

                                    } else if (resultado[0].ValorConsulta == "-1") {

                                        $("#LstReporte").addClass("hidden");
                                        $("#imgCargaLstReporte").addClass("hidden");
                                        $("#msjErrorLstReporte").addClass("hidden");
                                        $("#msjVacioLstReporte").addClass("hidden");
                                        $("#msjErrorListarLstReporte").addClass("hidden");
                                        $("#msjSuperaLimiteLstReporte").removeClass("hidden");

                                        $("#btnBuscar").prop('disabled', false);
                                        $("#BtnExportarExcel").prop('disabled', true);

                                    } else {

                                        $("#LstReporte").addClass("hidden");
                                        $("#imgCargaLstReporte").addClass("hidden");
                                        $("#msjErrorLstReporte").addClass("hidden");
                                        $("#msjVacioLstReporte").addClass("hidden");
                                        $("#msjErrorListarLstReporte").removeClass("hidden");
                                        $("#msjSuperaLimiteLstReporte").addClass("hidden");

                                        $("#btnBuscar").prop('disabled', true);
                                        $("#BtnExportarExcel").prop('disabled', true);
                                    }
                                } else {

                                    $("#LstReporte").addClass("hidden");
                                    $("#imgCargaLstReporte").addClass("hidden");
                                    $("#msjErrorLstReporte").addClass("hidden");
                                    $("#msjVacioLstReporte").removeClass("hidden");
                                    $("#msjErrorListarLstReporte").addClass("hidden");
                                    $("#msjSuperaLimiteLstReporte").addClass("hidden");

                                    $("#btnBuscar").prop('disabled', false);
                                    $("#BtnExportarExcel").prop('disabled', true);
                                }

                                options.success(resultado);
                                var grid = $("#LstReporte").data("kendoGrid");
                                if (grid.dataSource.total() > 0) {
                                    grid.setDataSource(dataSource);
                                }
                            },
                            error: function (xhr, ajaxOptions, thrownError) {

                                $("#LstReporte").addClass("hidden");
                                $("#imgCargaLstReporte").addClass("hidden");
                                $("#msjErrorLstReporte").removeClass("hidden");
                                $("#msjVacioLstReporte").addClass("hidden");
                                $("#msjErrorListarLstReporte").addClass("hidden");
                                $("#msjSuperaLimiteLstReporte").addClass("hidden");

                                $("#btnBuscar").prop('disabled', true);
                                $("#BtnExportarExcel").prop('disabled', true);

                                toastr.options.timeOut = nTiempoLargo;
                                toastr.options.extendedTimeOut = nTiempoLargo;
                                /*success - info - warning - error*/
                                var $toast = toastr["error"](tMensajeErrorConexion, tTituloErrorConexion); $toastlast = $toast;
                                console.log("ERROR AJAX : " + ajaxOptions);
                                console.log("ERROR AJAX : " + thrownError);
                                console.log(xhr.responseText);
                                console.log(xhr);
                            }
                        });
                    },
                    parameterMap: function (data, operation) {
                        if (operation !== "read" && data.models) {
                            return JSON.stringify({ JSONparam: data.models });
                        }
                    }
                },
                error: function (e) {
                    alert("Status: " + e.status + "; Error message: " + e.errorThrown);
                },
                batch: false,
                pageSize: PaginationKendoGrid,
                schema: {
                    model: {
                        fields: {
                            /*INCICENCIA*/
                            IdIndicator: { type: "number" },
                            IndicatorCode: { type: "string" },
                            IndicatorDescription: { type: "string" },
                            IndicatorTypeDescription: { type: "string" },
                            RegisterDetail: { type: "string" },
                            IdIndicatorUser: { type: "string" },
                            RegistrationUserName: { type: "string" },
                            /*AUDITORIA*/
                            //UserRegistrationDesc: { type: "string" }, //USUARIO DE REGISTRO
                            //UserDesc: { type: "string" },             // USUARIO ACTUALIZACIÓN
                            RegistrationDateString: { type: "string" }, //FECHA DE REGISTRO
                            UpdateDateString: { type: "string" },       //FECHA ACTUALIZACIÓN
                            //RegistrationStatusDesc: { type: "string" } //ESTADO DEL REGISTRO
                        }
                    }
                }
            });

            $("#LstReporte").kendoGrid({
                dataSource: dataSource,
                sortable: true,
                pageable: true,
                columnMenu: true,
                columnMenu: {
                    columns: true,
                    filterable: true,
                    sortable: true,
                    messages: {
                        columns: KendoMsjColumnMenuColumns,
                        filter: KendoMsjColumnMenuFilter,
                        sortAscending: KendoMsjColumnMenuSortAscending,
                        sortDescending: KendoMsjColumnMenuSortDescending,
                        settings: KendoMsjSettings
                    }
                },
                columnMenuInit: function (e) {
                    var menu = e.container.find(".k-menu").data("kendoMenu");
                    menu.bind("select", function (e) {
                        var EtiquetaInput = $(".k-animation-container > .k-menu-group > .k-item > .k-content > .k-filter-menu > .k-textbox :input");
                        EtiquetaInput.focus();
                    });
                },
                groupable: false,
                reorderable: true,
                selectable: "row",
                scrollable: true,
                resizable: true,
                filterable: {
                    multi: true,
                    checkAll: true,
                    search: true,
                    messages: {
                        clear: KendoMsjClear,
                        filter: KendoMsjFilter,
                        selectedItemsFormat: KendoMsjSelectedItemsFormat,
                        checkAll: KendoMsjCheckAll,
                        search: KendoMsjSearch
                    }
                },
                pageable: {
                    info: true,
                    messages: {
                        empty: KendoMsjEmpty,
                        page: kendoMsjPage,
                        of: KendoMsjOf,
                        itemsPerPage: KendoMsjItemsPerPage,
                        first: KendoMsjFirst,
                        last: KendoMsjLast,
                        next: KendoMsjNext,
                        previous: KendoMsjPrevious,
                        refresh: KendoMsjRefresh,
                        morePages: KendoMsjMorePages,
                        display: KendoMsjDisplay
                    },
                    refresh: false,
                    pageSize: 10,
                    pageSizes: true,
                    pageSizes: [5, 10, 15],
                    buttonCount: 5
                },
                //toolbar: ["excel"],
                excel: { fileName: "Reporte Incidencias.xlsx", filterable: true, allPages: true },
                columns: [
                    {
                        width: 130,
                        command: {
                            template: "<button class='btn-grid btn-xs BtnComments' type='button' title='Ver'><i class='fa fa-lg fa-fw fa-comments-o'></i></button>"
                        },
                        attributes: { "class": "text-center" },
                        title: ""
                    },
                    /*REPORTE*/
                    //{ field: "IdIndicator", title: "IdIndicador", width: 120, hidden: true, attributes: { "class": "text-center" }},
                    { field: "IndicatorCode", title: "Código Indicador", width: 120, attributes: { "class": "text-center" } },
                    { field: "IndicatorDescription", title: "Indicador", width: 120, attributes: { "class": "text-center" } },
                    { field: "bE_Indicator_Type.IndicatorTypeDescription", title: "Tipo Indicador", width: 120, attributes: { "class": "text-center" } },
                    { field: "bE_Indicator_User.RegisterDetail", title: "Detalle", width: 120, attributes: { "class": "text-center" } },
                    { field: "bE_Indicator_User.RegistrationUserName", title: "Usuario", width: 120, attributes: { "class": "text-center" } },

                    { field: "bE_Indicator_User.RegistrationDateString", title: "Fecha Registro", width: 160, format: "{0:dd/MM/yyyy HH:mm:ss}", attributes: { "class": "text-center" } }//,
                    //{ field: "bE_Indicator_User.UpdateDateString", title: "Fecha Actualización", width: 160, format: "{0:dd/MM/yyyy HH:mm:ss}", attributes: { "class": "text-center" } }
                ]
            });
        }
    }

    //---------------------------------------------------------------------------------------------------- FUNCIONES GUARDAR/ACTUALIZAR/ELIMINAR ETC*/
    function CrearComentario() {

        var comentario = $("#txtNuevoComentario").val().trim();
        var comentarios = comentario.replace(/\n/g, " ");

        $.ajax({
            type: "POST",
            url: tRutaServidor + "/IndicatorAnswer/CrearRespuestaIndicador",
            //contentType: "application/json; charset=utf-8",
            data: {
                IdIndicatorUser: idIndicadorUser,
                Comment: comentarios
            },
            dataType: "json",
            success: function (resultado) {

                if (resultado == "1") {

                    toastr.options.timeOut = nTiempoCorto;
                    toastr.options.extendedTimeOut = nTiempoCorto;
                    /*success - info - warning - error*/
                    var $toast = toastr["success"](tMensajeCreadoExito, tTituloExito); $toastlast = $toast;

                    $("#txtNuevoComentario").val("");

                    ObtenerComentarios(idIndicadorUser);

                    $("#imgCargaComentario").removeClass("hidden");
                    $("#msjErrorComentario").addClass("hidden");
                    $("#msjErrorListarComentario").addClass("hidden");
                    $("#msjVacioComentario").addClass("hidden");

                } else if (resultado == "0") {
                    $("#imgCargaComentario").addClass("hidden");
                    toastr.options.timeOut = nTiempoMedio;
                    toastr.options.extendedTimeOut = nTiempoMedio;
                    /*success - info - warning - error*/
                    var $toast = toastr["error"](tMensajeErrorDesconocido, tTituloError); $toastlast = $toast;
                    console.log(tMensajeLogError + resultado);
                } else {
                    $("#imgCargaComentario").addClass("hidden");
                    toastr.options.timeOut = nTiempoMedio;
                    toastr.options.extendedTimeOut = nTiempoMedio;
                    /*success - info - warning - error*/
                    var $toast = toastr["error"](tMensajeErrorDesconocido, tTituloError); $toastlast = $toast;
                    console.log(tMensajeLogError + resultado);
                }

            },
            error: function (xhr, ajaxOptions, thrownError) {
                $("#imgCargaComentario").addClass("hidden");
                /*fallo al llamar a la funcion ajax*/
                toastr.options.timeOut = nTiempoLargo;
                toastr.options.extendedTimeOut = nTiempoLargo;
                /*success - info - warning - error*/
                var $toast = toastr["error"](tMensajeErrorConexion, tTituloErrorConexion); $toastlast = $toast;
                console.log("ERROR AJAX : " + ajaxOptions);
                console.log("ERROR AJAX : " + thrownError);
                console.log(xhr.responseText);
                console.log(xhr);
            }
        });
    }

    function CrearComentarioConAdjunto() {

        var fileData = new FormData();
        var fileUpload = $("#flArchivoSubir").get(0);
        var files = fileUpload.files;
        for (var i = 0; i < files.length; i++) {
            fileData.append(files[i].name, files[i]);
        }

        $("#ComentariosIncidencia").addClass("hidden");
        $("#imgCargaComentario").removeClass("hidden");
        $("#msjErrorComentario").addClass("hidden");

        $.ajax({
            type: "POST",
            url: tRutaServidor + "/IndicatorAnswer/CrearRespuestaIndicadorConAdjunto?IdIndicatorUser=" + idIndicadorUser + "&TipoIndicador=" + tipoIndicador,
            data: fileData,
            contentType: false, // Not to set any content header
            processData: false, // Not to process data
            success: function (resultado) {

                if (resultado.length > 0) {
                    var nuevoResultado = resultado.split("-");

                    if (nuevoResultado[1] == 1) {

                        $("#imgCargaComentario").addClass("hidden");

                        $("#flArchivoSubir").filestyle('clear');
                        //toastr.options.timeOut = nTiempoMedio;
                        //toastr.options.extendedTimeOut = nTiempoMedio;
                        ///*success - info - warning - error*/
                        //var $toast = toastr["success"](tMensajeCreadoExito, tTituloExito); $toastlast = $toast;

                        idIndicatorComment = nuevoResultado[0];
                        var comment = $("#txtNuevoComentario").val();

                        ActualizarComentario(comment);

                    } else if (nuevoResultado[1] == 102 || nuevoResultado[0] == 102) {
                        $("#imgCargaComentario").addClass("hidden");
                        $("#msjErrorComentario").addClass("hidden");
                        $("#msjVacioComentario").removeClass("hidden");
                        $("#msjErrorListarComentario").addClass("hidden");

                        toastr.options.timeOut = nTiempoMedio;
                        toastr.options.extendedTimeOut = nTiempoMedio;
                        /*success - info - warning - error*/
                        var $toast = toastr["error"](tValidacionTipoArchivo, tTituloError); $toastlast = $toast;
                        console.log(tMensajeLogError + resultado);
                    } else if (nuevoResultado[1] == 101 || nuevoResultado[0] == 102) {
                        $("#imgCargaComentario").addClass("hidden");
                        $("#msjErrorComentario").addClass("hidden");
                        $("#msjVacioComentario").removeClass("hidden");
                        $("#msjErrorListarComentario").addClass("hidden");

                        toastr.options.timeOut = nTiempoMedio;
                        toastr.options.extendedTimeOut = nTiempoMedio;
                        /*success - info - warning - error*/
                        var $toast = toastr["error"](tValidacionPesoArchivo, tTituloError); $toastlast = $toast;
                        console.log(tMensajeLogError + resultado);
                    } else {
                        $("#imgCargaComentario").addClass("hidden");
                        $("#msjErrorComentario").addClass("hidden");
                        $("#msjVacioComentario").addClass("hidden");
                        $("#msjErrorListarComentario").removeClass("hidden");

                        toastr.options.timeOut = nTiempoMedio;
                        toastr.options.extendedTimeOut = nTiempoMedio;
                        /*success - info - warning - error*/
                        var $toast = toastr["error"](tMensajeErrorDesconocido, tTituloError); $toastlast = $toast;
                        console.log(tMensajeLogError + resultado);
                    }
                } else {
                    $("#imgCargaComentario").addClass("hidden");
                    $("#msjErrorComentario").addClass("hidden");
                    $("#msjVacioComentario").removeClass("hidden");
                    $("#msjErrorListarComentario").addClass("hidden");
                    toastr.options.timeOut = nTiempoMedio;
                    toastr.options.extendedTimeOut = nTiempoMedio;
                    /*success - info - warning - error*/
                    var $toast = toastr["error"](tMensajeErrorDesconocido, tTituloError); $toastlast = $toast;
                    console.log(tMensajeLogError + resultado);
                }
            },
            error: function (xhr, ajaxOptions, thrownError) {

                $("#imgCargaComentario").addClass("hidden");
                $("#msjErrorComentario").removeClass("hidden");
                $("#msjVacioComentario").addClass("hidden");
                $("#msjErrorListarComentario").addClass("hidden");
                /*fallo al llamar a la funcion ajax*/
                toastr.options.timeOut = nTiempoLargo;
                toastr.options.extendedTimeOut = nTiempoLargo;
                /*success - info - warning - error*/
                var $toast = toastr["error"](tMensajeErrorConexion, tTituloErrorConexion); $toastlast = $toast;
                console.log("ERROR AJAX : " + ajaxOptions);
                console.log("ERROR AJAX : " + thrownError);
                console.log(xhr.responseText);
                console.log(xhr);

            }
        });

    }

    function ActualizarComentario(comment) {

        $("#imgCargaComentario").removeClass("hidden");

        var comentario = "";

        if (comment == "") {
            comentario = $("#txtComentario").val().trim();
        } else {
            comentario = comment;
        }

        var comentarios = comentario.replace(/\n/g, " ");

        $.ajax({
            type: "POST",
            url: tRutaServidor + "/IndicatorAnswer/ActualizarRespuestaIndicador",
            //contentType: "application/json; charset=utf-8",
            data: {
                IdIndicatorComment: idIndicatorComment,
                Comment: comentarios
            },
            dataType: "json",
            success: function (resultado) {

                if (resultado == "1") {
                    $("#imgCargaComentario").addClass("hidden");
                    toastr.options.timeOut = nTiempoCorto;
                    toastr.options.extendedTimeOut = nTiempoCorto;
                    /*success - info - warning - error*/
                    var $toast = toastr["success"](tMensajeCreadoExito, tTituloExito); $toastlast = $toast;

                    if (comment == "") {
                        $("#txtComentario").val("");
                    } else {
                        $("#txtNuevoComentario").val("");
                    }

                    ObtenerComentarios(idIndicadorUser);

                    $("#imgCargaComentario").removeClass("hidden");

                    $('#ModalActualizarComment').modal('hide');

                } else if (resultado == "0") {
                    $("#imgCargaComentario").addClass("hidden");
                    toastr.options.timeOut = nTiempoMedio;
                    toastr.options.extendedTimeOut = nTiempoMedio;
                    /*success - info - warning - error*/
                    var $toast = toastr["error"](tMensajeErrorDesconocido, tTituloError); $toastlast = $toast;
                    console.log(tMensajeLogError + resultado);
                } else if (resultado == "3") {
                    $("#imgCargaComentario").addClass("hidden");
                    toastr.options.timeOut = nTiempoMedio;
                    toastr.options.extendedTimeOut = nTiempoMedio;
                    /*success - info - warning - error*/
                    var $toast = toastr["error"](tMensajeErrorNoExiste, tTituloError); $toastlast = $toast;
                    console.log(tMensajeLogError + resultado);
                } else {
                    $("#imgCargaComentario").addClass("hidden");
                    toastr.options.timeOut = nTiempoMedio;
                    toastr.options.extendedTimeOut = nTiempoMedio;
                    /*success - info - warning - error*/
                    var $toast = toastr["error"](tMensajeErrorDesconocido, tTituloError); $toastlast = $toast;
                    console.log(tMensajeLogError + resultado);
                }

            },
            error: function (xhr, ajaxOptions, thrownError) {
                $("#imgCargaComentario").addClass("hidden");
                /*fallo al llamar a la funcion ajax*/
                toastr.options.timeOut = nTiempoLargo;
                toastr.options.extendedTimeOut = nTiempoLargo;
                /*success - info - warning - error*/
                var $toast = toastr["error"](tMensajeErrorConexion, tTituloErrorConexion); $toastlast = $toast;
                console.log("ERROR AJAX : " + ajaxOptions);
                console.log("ERROR AJAX : " + thrownError);
                console.log(xhr.responseText);
                console.log(xhr);
            }
        });
    }

    function ActualizarComentarioConAdjunto() {

        var fileData = new FormData();
        var fileUpload = $("#flArchivoSubirActualizar").get(0);
        var files = fileUpload.files;
        for (var i = 0; i < files.length; i++) {
            fileData.append(files[i].name, files[i]);
        }

        $("#ComentariosIncidencia").addClass("hidden");
        $("#imgCargaComentario").removeClass("hidden");
        $("#msjErrorComentario").addClass("hidden");

        $.ajax({
            type: "POST",
            url: tRutaServidor + "/IndicatorAnswer/ActualizarRespuestaIndicadorConAdjunto?IdIndicatorComment=" + idIndicatorComment + "&IdIndicatorUser=" + idIndicadorUser + "&TipoIndicador=" + tipoIndicador,
            data: fileData,
            contentType: false, // Not to set any content header
            processData: false, // Not to process data
            success: function (resultado) {
                console.log(resultado);
                if (resultado.length > 0) {

                    if (resultado == 1) {
                        $("#flArchivoSubirActualizar").filestyle('clear');
                        //toastr.options.timeOut = nTiempoMedio;
                        //toastr.options.extendedTimeOut = nTiempoMedio;
                        ///*success - info - warning - error*/
                        //var $toast = toastr["success"](tMensajeCreadoExito, tTituloExito); $toastlast = $toast;

                        ActualizarComentario("");

                    } else if (resultado === "102") {
                        $("#imgCargaComentario").addClass("hidden");

                        toastr.options.timeOut = nTiempoMedio;
                        toastr.options.extendedTimeOut = nTiempoMedio;
                        /*success - info - warning - error*/
                        var $toast = toastr["error"](tValidacionTipoArchivo, tTituloError); $toastlast = $toast;
                        console.log(tMensajeLogError + resultado);
                    } else if (resultado == 101) {
                        $("#imgCargaComentario").addClass("hidden");

                        toastr.options.timeOut = nTiempoMedio;
                        toastr.options.extendedTimeOut = nTiempoMedio;
                        /*success - info - warning - error*/
                        var $toast = toastr["error"](tMensajeErrorDesconocido, tTituloError); $toastlast = $toast;
                        console.log(tMensajeLogError + resultado);
                    } else if (resultado == "3") {
                        $("#imgCargaComentario").addClass("hidden");
                        toastr.options.timeOut = nTiempoMedio;
                        toastr.options.extendedTimeOut = nTiempoMedio;
                        /*success - info - warning - error*/
                        var $toast = toastr["error"](tMensajeErrorNoExiste, tTituloError); $toastlast = $toast;
                        console.log(tMensajeLogError + resultado);
                    } else {
                        $("#imgCargaComentario").addClass("hidden");
                        toastr.options.timeOut = nTiempoMedio;
                        toastr.options.extendedTimeOut = nTiempoMedio;
                        /*success - info - warning - error*/
                        var $toast = toastr["error"](tMensajeErrorDesconocido, tTituloError); $toastlast = $toast;
                        console.log(tMensajeLogError + resultado);
                    }
                }
            },
            error: function (xhr, ajaxOptions, thrownError) {

                $("#imgCargaComentario").addClass("hidden");
                /*fallo al llamar a la funcion ajax*/
                toastr.options.timeOut = nTiempoLargo;
                toastr.options.extendedTimeOut = nTiempoLargo;
                /*success - info - warning - error*/
                var $toast = toastr["error"](tMensajeErrorConexion, tTituloErrorConexion); $toastlast = $toast;
                console.log("ERROR AJAX : " + ajaxOptions);
                console.log("ERROR AJAX : " + thrownError);
                console.log(xhr.responseText);
                console.log(xhr);

            }
        });

    }

    $("#LstReporte").delegate(".BtnComments", "click", function (e) {

        var grid = $("#LstReporte").data("kendoGrid");
        var myVar = grid.dataItem($(this).closest("tr"));

        $("#lblIncidencia").text(myVar.IndicatorDescription);
        $("#lblFecha").text(myVar.bE_Indicator_User.RegistrationDateString);
        $("#txtDetalle").val(myVar.bE_Indicator_User.RegisterDetail);
      
        tipoIndicador = myVar.bE_Indicator_Type.IndicatorTypeDescription;
        idIndicadorUser = myVar.bE_Indicator_User.IdIndicatorUser;
        ObtenerComentarios(myVar.bE_Indicator_User.IdIndicatorUser);

        $('#ModalComment').modal('show');
        $("#txtNuevoComentario").val("");

    });

    $("#btnAgregarComentario").click(function () {

        $.validator.addMethod("regxNuevo", function (value, element, regexpr) {
            return regexpr.test(value);
        }, "Caracteres invalidos");

        var $registerForm = $("#FrmComentarioIncidencia").validate({
            rules: {
                txtNuevoComentario: {
                    required: true,
                    maxlength: 500,
                    minlength: 3,
                    regxNuevo: ReSoloAlfanumericosConEspacioYComaPuntoTextArea
                }
            },
            messages: {
                txtNuevoComentario: {
                    required: tCampoRequerido,
                    minlength: tMinLength,
                    maxlength: tMaxLength,
                    regxNuevo: tCaracteresNoValido
                }
            },
            submitHandler: function (form) {

                if ($("#txtNuevoComentario").val().trim() == "") {
                    toastr.options.timeOut = nTiempoMedio;
                    toastr.options.extendedTimeOut = nTiempoMedio;
                    /*success - info - warning - error*/
                    var $toast = toastr["error"](tValoresVacios, tTituloError); $toastlast = $toast;
                    return;
                }

                if ($('#flArchivoSubir').val() != "") {
                    var TamañoArchivo = $("#flArchivoSubir")[0].files[0].size;
                    if (TamañoArchivo > 5000000) {
                        toastr.options.timeOut = nTiempoMedio;
                        toastr.options.extendedTimeOut = nTiempoMedio;
                        /*success - info - warning - error*/
                        var $toast = toastr["error"](tValidacionExcedeTamanioArchivoError, tTituloError); $toastlast = $toast;
                        return;
                    }

                    CrearComentarioConAdjunto();
                } else {
                    CrearComentario();
                }
            },

            errorPlacement: function (error, element) {
                console.log(error);
                error.insertAfter(element.parent());
            }
        });

    });

    //---------------------------------------------------------------------------------------------------- COMBOS

    function ComboTipoIndicador() {

        $("#imgCargaLstReporte").removeClass("hidden");
        $.ajax({
            type: "GET", /*Puede ser post*/
            url: tRutaServidor + "/Indicator/ListarTipoIndicador", /* es importante poner los .. delante*/
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            /*async: false,*/
            success: function (resultado) {
                /*exitosamente*/
                if (resultado.length > 0) {
                    /* proceso exitoso con datos*/
                    if (resultado[0].ValorConsulta == "1") {

                        if (resultado.length > 1) {
                            resultado.push({ IdIndicatorType: 0, IndicatorTypeDescription: 'TODOS LOS TIPOS' });
                        }

                        $("#cboTipo").kendoDropDownList({
                            dataTextField: "IndicatorTypeDescription",
                            dataValueField: "IdIndicatorType",
                            filter: "contains",
                            autoBind: true,
                            minLength: 1,
                            dataSource: {
                                data: resultado
                            },
                            select: onSelectTypeIndicator
                        });

                        if (idTipoIndicador != 0) {
                            $("#cboTipo").data("kendoDropDownList").value(idTipoIndicador);
                        } else {
                            idTipoIndicador = 0;
                            $("#cboTipo").data("kendoDropDownList").value(idTipoIndicador);
                            idTipoIndicador = $("#cboTipo").data("kendoDropDownList").value();
                        }

                        ComboIndicadores(idTipoIndicador);

                    } else {
                        idTipoIndicador = 0;

                        /* proceso fallido catch listado datos*/
                        toastr.options.timeOut = nTiempoMedio;
                        toastr.options.extendedTimeOut = nTiempoMedio;
                        /*success - info - warning - error*/
                        var $toast = toastr["error"](tValidacionListaComboTipoIndicadorError, tTituloError); $toastlast = $toast;
                        console.log(tMensajeLogError + resultado[0].MensajeConsulta);
                        $("#imgCargaLstReporte").addClass("hidden");
                        $("#msjErrorLstReporte").addClass("hidden");
                        $("#msjVacioLstReporte").addClass("hidden");
                        $("#msjErrorListarLstReporte").removeClass("hidden");
                        $("#msjSuperaLimiteLstReporte").addClass("hidden");
                    }

                } else {
                    idTipoIndicador = 0;

                    /* lista vacia */
                    toastr.options.timeOut = nTiempoMedio;
                    toastr.options.extendedTimeOut = nTiempoMedio;
                    /*success - info - warning - error*/
                    var $toast = toastr["error"](tValidacionListaComboTipoIndicadorVacio, tTituloError); $toastlast = $toast;

                    $("#imgCargaLstReporte").addClass("hidden");
                    $("#msjErrorLstReporte").addClass("hidden");
                    $("#msjVacioLstReporte").removeClass("hidden");
                    $("#msjErrorListarLstReporte").addClass("hidden");
                    $("#msjSuperaLimiteLstReporte").addClass("hidden");
                }

            },
            error: function (xhr, ajaxOptions, thrownError) {

                $("#imgCargaLstReporte").addClass("hidden");
                $("#msjErrorLstReporte").removeClass("hidden");
                $("#msjVacioLstReporte").addClass("hidden");
                $("#msjErrorListarLstReporte").addClass("hidden");
                $("#msjSuperaLimiteLstReporte").addClass("hidden");

                /*fallo al llamar a la funcion ajax*/
                toastr.options.timeOut = nTiempoLargo;
                toastr.options.extendedTimeOut = nTiempoLargo;
                /*success - info - warning - error*/
                var $toast = toastr["error"](tMensajeErrorConexion, tTituloErrorConexion); $toastlast = $toast;
                console.log("ERROR AJAX : " + ajaxOptions);
                console.log("ERROR AJAX : " + thrownError);
                console.log(xhr.responseText);
                console.log(xhr);
            }
        });
    }

    function ComboIndicadores(tipoIndicador) {

        var valorBusqueda = "";

        $.ajax({
            type: "GET", /*Puede ser post*/
            url: tRutaServidor + "/Indicator/listarIndicadorPorTipo", /* es importante poner los .. delante*/
            contentType: "application/json; charset=utf-8",
            data: "IdIndicatorType=" + tipoIndicador,
            dataType: "json",
            /*async: false,*/
            success: function (resultado) {
                /*exitosamente*/
                if (resultado.length > 0) {
                    /* proceso exitoso con datos*/
                    if (resultado[0].ValorConsulta == "1") {

                        if (resultado.length > 1) {
                            resultado.push({ IdIndicator: 0, IndicatorCodeDescription: 'TODAS LAS INDICENCIAS' });
                        }

                        $("#cboIncidencia").kendoDropDownList({
                            dataTextField: "IndicatorCodeDescription",
                            dataValueField: "IdIndicator",
                            filter: "contains",
                            autoBind: true,
                            minLength: 1,
                            dataSource: {
                                data: resultado
                            },
                            select: onSelectIndicator
                        });

                        if (tipoIndicador == 0) {
                            $("#cboIncidencia").data("kendoDropDownList").value(0);
                            idIndicator = $("#cboIncidencia").data("kendoDropDownList").value();
                        } else {
                            if (idIndicator != 0) {
                                $("#cboIncidencia").data("kendoDropDownList").value(idIndicator);
                            } else {
                                $("#cboIncidencia").data("kendoDropDownList").value(resultado[0].IdIndicator);
                                idIndicator = $("#cboIncidencia").data("kendoDropDownList").value();
                            }
                        }

                        //$("#imgCargaLstReporte").addClass("hidden");
                        GrillaListado();

                    } else {
                        idIndicator = 0;
                        /* proceso fallido catch listado datos*/
                        toastr.options.timeOut = nTiempoMedio;
                        toastr.options.extendedTimeOut = nTiempoMedio;
                        /*success - info - warning - error*/
                        var $toast = toastr["error"](tValidacionListaComboIndicadorError, tTituloError); $toastlast = $toast;
                        console.log(tMensajeLogError + resultado[0].MensajeConsulta);
                        $("#imgCargaLstReporte").addClass("hidden");
                        $("#msjErrorLstReporte").addClass("hidden");
                        $("#msjVacioLstReporte").addClass("hidden");
                        $("#msjErrorListarLstReporte").removeClass("hidden");
                        $("#msjSuperaLimiteLstReporte").addClass("hidden");
                    }
                } else {
                    idIndicator = 0;
                    /* lista vacia */
                    toastr.options.timeOut = nTiempoMedio;
                    toastr.options.extendedTimeOut = nTiempoMedio;
                    /*success - info - warning - error*/
                    var $toast = toastr["error"](tValidacionListaComboIndicadorVacio, tTituloError); $toastlast = $toast;
                    $("#imgCargaLstReporte").addClass("hidden");
                    $("#msjErrorLstReporte").addClass("hidden");
                    $("#msjVacioLstReporte").removeClass("hidden");
                    $("#msjErrorListarLstReporte").addClass("hidden");
                    $("#msjSuperaLimiteLstReporte").addClass("hidden");
                }
            },
            error: function (xhr, ajaxOptions, thrownError) {
                idIndicator = 0;
                $("#imgCargaLstReporte").addClass("hidden");
                $("#msjErrorLstReporte").removeClass("hidden");
                $("#msjVacioLstReporte").addClass("hidden");
                $("#msjErrorListarLstReporte").addClass("hidden");
                $("#msjSuperaLimiteLstReporte").addClass("hidden");

                /*fallo al llamar a la funcion ajax*/
                toastr.options.timeOut = nTiempoLargo;
                toastr.options.extendedTimeOut = nTiempoLargo;
                /*success - info - warning - error*/
                var $toast = toastr["error"](tMensajeErrorConexion, tTituloErrorConexion); $toastlast = $toast;
                console.log("ERROR AJAX : " + ajaxOptions);
                console.log("ERROR AJAX : " + thrownError);
                console.log(xhr.responseText);
                console.log(xhr);
            }
        });
    }

    //---------------------------------------------------------------------------------------------------- EVENTOS SELECT COMBOS

    function onSelectTypeIndicator(e) {
        var dataItem = this.dataItem(e.item.index());
        idTipoIndicador = dataItem.IdIndicatorType;
        idIndicator = 0;
        //ComboIndicadores(idTipoIndicador);
    };

    function onSelectIndicator(e) {
        var dataItem = this.dataItem(e.item.index());
        idIndicator = dataItem.IdIndicator;
    }

    //---------------------------------------------------------------------------------------------------- OTRAS
    function FormatoFechas() {

        var FechaHoy = new Date();
        var FechaMañana = new Date(FechaHoy.getFullYear(), FechaHoy.getMonth(), FechaHoy.getDate());
        var primerDia = new Date(FechaHoy.getFullYear(), FechaHoy.getMonth(), 1);

        $('#txtFechaInicio').datepicker({
            keyboardNavigation: false,
            forceParse: false,
            autoclose: true,
            format: 'dd/mm/yyyy',
            endDate: FechaMañana,
        });


        $('#txtFechaFinal').datepicker({
            keyboardNavigation: false,
            forceParse: false,
            autoclose: true,
            format: 'dd/mm/yyyy',
            endDate: FechaMañana,
        });

        $("#txtFechaInicio").datepicker("setDate", primerDia);
        $("#txtFechaFinal").datepicker("setDate", FechaMañana);
    }

    function ExportarExcel(Etiqueta) {
        var Grilla = $("#" + Etiqueta).data("kendoGrid");
        var count = Grilla.dataSource.total();

        if (count > CantidadRegistrosExportar) {

            swal({
                title: tTituloConfirmacionExportarExcel,
                text: tMensajeConfirmacionExportarExcel,
                type: "warning",
                showCancelButton: true,
                confirmButtonColor: tColorBoton,
                confirmButtonText: tNombreBotonSi,
                cancelButtonText: tNombreBotonNo,
                closeOnConfirm: true
            }, function () {

                setTimeout(function () {
                    swal({
                        title: tTituloExportarExcel,
                        text: tMensajeExportarExcel,
                        type: "warning"
                    });
                }, 500);

                setTimeout(function () {
                    Grilla.saveAsExcel();
                }, 2000)

            });

        } else {
            swal({
                title: tTituloExportarExcel,
                text: tMensajeExportarExcel,
                type: "warning"
            });

            setTimeout(function () {

                Grilla.saveAsExcel();
            }, 2000)
        }
    };

    function ExportarPDF(contenedor, NombrePdf) {
        // Convert the DOM element to a drawing using kendo.drawing.drawDOM
        kendo.drawing.drawDOM($("#" + contenedor + ""))
        .then(function (group) {
            // Render the result as a PDF file
            return kendo.drawing.exportPDF(group, {
                paperSize: "auto",
                margin: { left: "1cm", top: "1cm", right: "1cm", bottom: "1cm" }
            });
        })
        .done(function (data) {
            // Save the PDF file
            kendo.saveAs({
                dataURI: data,
                fileName: NombrePdf + ".pdf",
            });
            $(".ContenedorFecha").css("justify-content", "space-between");
            $(".ContenedorOcultarExportar").removeClass("hidden");
        });
    }

    //---------------------------------------------------------------------------------------------------- ASIGNAR FUNCIONES
    $("#btnBuscar").click(function () {

        $.validator.addMethod("regx", function (value, element, regexpr) {
            return regexpr.test(value);
        }, "Caracteres invalidos");

        var $registerForm = $("#FrmFiltros").validate({
            rules: {
                txtFechaInicio: {
                    required: true,
                    regx: /^(?:(?:31(\/|-|\.)(?:0?[13578]|1[02]))\1|(?:(?:29|30)(\/|-|\.)(?:0?[1,3-9]|1[0-2])\2))(?:(?:1[6-9]|[2-9]\d)?\d{2})$|^(?:29(\/|-|\.)0?2\3(?:(?:(?:1[6-9]|[2-9]\d)?(?:0[48]|[2468][048]|[13579][26])|(?:(?:16|[2468][048]|[3579][26])00))))$|^(?:0?[1-9]|1\d|2[0-8])(\/|-|\.)(?:(?:0?[1-9])|(?:1[0-2]))\4(?:(?:1[6-9]|[2-9]\d)?\d{2})$/
                },
                txtFechaFinal: {
                    required: true,
                    regx: /^(?:(?:31(\/|-|\.)(?:0?[13578]|1[02]))\1|(?:(?:29|30)(\/|-|\.)(?:0?[1,3-9]|1[0-2])\2))(?:(?:1[6-9]|[2-9]\d)?\d{2})$|^(?:29(\/|-|\.)0?2\3(?:(?:(?:1[6-9]|[2-9]\d)?(?:0[48]|[2468][048]|[13579][26])|(?:(?:16|[2468][048]|[3579][26])00))))$|^(?:0?[1-9]|1\d|2[0-8])(\/|-|\.)(?:(?:0?[1-9])|(?:1[0-2]))\4(?:(?:1[6-9]|[2-9]\d)?\d{2})$/
                }
            },
            messages: {
                txtFechaInicio: {
                    required: tCampoRequerido,
                    regx: tFormatoFechaNoValido
                },
                txtFechaFinal: {
                    required: tCampoRequerido,
                    regx: tFormatoFechaNoValido
                }
            },
            submitHandler: function (form) {
                $("#LstReporte").addClass("hidden");
                $("#imgCargaLstReporte").removeClass("hidden");
                $("#msjErrorLstReporte").addClass("hidden");
                $("#msjVacioLstReporte").addClass("hidden");
                $("#msjErrorListarLstReporte").addClass("hidden");
                $("#msjSuperaLimiteLstReporte").addClass("hidden");
                $("#LstReporte").data("kendoGrid").dataSource.read();

                $("#btnBuscar").prop('disabled', true);
                $("#BtnExportarExcel").prop('disabled', true);
            },
            errorPlacement: function (error, element) {
                error.insertAfter(element.parent());
            }
        });
    });

    $("#BtnExportarExcel").click(function () {
        ExportarExcel("LstReporte");
    });

    $("#BtnExportarPDF").click(function () {
        ExportarPDF("ContenedorComentario", "Comentarios");
    });

    $("#btnInformativo").click(function () {
        MostrarMapaTitle();
    });

    /*----------------------------------------------------------------------------------------------- ASIGNAR FUNCIONES COMENTARIO*/
    $("#cbtnCancelar").click(function () {
        $('#ModalActualizarComment').modal('hide');
    });

    $("#cbtnGrabar").click(function () {

        $.validator.addMethod("regxEditar", function (value, element, regexpr) {
            return regexpr.test(value);
        }, "Caracteres invalidos");

        var $registerForm = $("#FrmActualizarComentario").validate({
            rules: {
                txtComentario: {
                    maxlength: 500,
                    minlength: 3,
                    regxEditar: ReSoloAlfanumericosConEspacioYComaPuntoTextArea 
                }
            },
            messages: {
                txtComentario: {
                    minlength: tMinLength,
                    maxlength: tMaxLength,
                    regxEditar: tCaracteresNoValido
                }
            },
            submitHandler: function (form) {
                if ($("#txtComentario").val().trim() == "") {
                    toastr.options.timeOut = nTiempoCorto;
                    toastr.options.extendedTimeOut = nTiempoCorto;
                    /*success - info - warning - error*/
                    var $toast = toastr["error"](tValoresVacios, tTituloError); $toastlast = $toast;
                    return;
                }

                swal({
                    title: tTituloConfirmacion,
                    text: tMensajeConfirmacionEdicionComentario,
                    type: "warning",
                    showCancelButton: true,
                    confirmButtonColor: tColorBoton,
                    confirmButtonText: tNombreBotonSi,
                    cancelButtonText: tNombreBotonNo,
                    closeOnConfirm: true
                }, function () {
                    if ($('#flArchivoSubirActualizar').val() != "") {
                        var TamañoArchivo = $("#flArchivoSubirActualizar")[0].files[0].size;
                        if (TamañoArchivo > 5000000) {
                            toastr.options.timeOut = nTiempoMedio;
                            toastr.options.extendedTimeOut = nTiempoMedio;
                            /*success - info - warning - error*/
                            var $toast = toastr["error"](tValidacionExcedeTamanioArchivoError, tTituloError); $toastlast = $toast;
                            return;
                        }
                        ActualizarComentarioConAdjunto();
                    } else {
                        ActualizarComentario("");
                    }
                });
            },
            errorPlacement: function (error, element) {
                error.insertAfter(element.parent());
            }
        });

    });

    $('.dtpickerFI').on('click', function () {
        if (!document.getElementById('txtFechaInicio').disabled) {
            $('#txtFechaInicio').datepicker('show');
        }

    });

    $('.dtpickerFF').on('click', function () {
        if (!document.getElementById('txtFechaFinal').disabled) {
            $('#txtFechaFinal').datepicker('show');
        }

    });
    //---------------------------------------------------------------------------------------------------- METODOS INICIALES
    FormatoFechas();
    ComboTipoIndicador();
    //GrillaListado();

    /* });*/

    </script>
</div>

